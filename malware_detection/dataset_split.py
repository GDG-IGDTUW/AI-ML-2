import os
os.environ["OMP_NUM_THREADS"] = "1"

import pandas as pd
from sklearn.model_selection import train_test_split
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.feature_selection import mutual_info_classif

def stratified_train_test_split(
    csv_path,
    label_column="label",
    test_size=0.2,
    random_state=42,
    output_dir="splits"
):
    """
    Performs a stratified, reproducible train-test split
    while preventing data leakage.
    """

    # Load dataset
    df = pd.read_csv(csv_path)

    # Separate features and labels
    X = df.drop(columns=[label_column])
    y = df[label_column]

    # Stratified split
    X_train, X_test, y_train, y_test = train_test_split(
        X,
        y,
        test_size=test_size,
        stratify=y,
        random_state=random_state
    )

    # Recombine for clean datasets
    train_df = X_train.copy()
    train_df[label_column] = y_train

    test_df = X_test.copy()
    test_df[label_column] = y_test

    # Save outputs
    train_path = f"{output_dir}/train.csv"
    test_path = f"{output_dir}/test.csv"

    train_df.to_csv(train_path, index=False)
    test_df.to_csv(test_path, index=False)

    print("✅ Stratified split completed")
    print(f"Train shape: {train_df.shape}")
    print(f"Test shape: {test_df.shape}")

    return train_path, test_path


def feature_separability_top_features(csv_path, label_column="label", top_n=5, plot_dir="top_feature_plots"):
    """
    Save only the top N feature plots in a folder and a ranking CSV in the current folder.
    """

    import os
    import pandas as pd
    import matplotlib.pyplot as plt
    from sklearn.feature_selection import mutual_info_classif

    df = pd.read_csv(csv_path)

    benign = df[df[label_column] == 0]
    malicious = df[df[label_column] == 1]

    print("\nBenign samples:", len(benign))
    print("Malicious samples:", len(malicious))

    X = df.drop(columns=[label_column])
    y = df[label_column]

    mi_scores = mutual_info_classif(X, y)

    separability = pd.DataFrame({
        "Feature": X.columns,
        "Separability Score": mi_scores
    }).sort_values(by="Separability Score", ascending=False)

    # Save ranking CSV in current folder
    separability.to_csv("feature_separability_ranking.csv", index=False)
    print("✅ Saved ranking → feature_separability_ranking.csv")

    # Make folder for top feature plots
    os.makedirs(plot_dir, exist_ok=True)

    top_features = separability.head(top_n)["Feature"]

    for feature in top_features:
        benign_counts = benign[feature].value_counts(normalize=True)
        mal_counts = malicious[feature].value_counts(normalize=True)

        plot_df = pd.DataFrame({
            "Benign": benign_counts,
            "Malware": mal_counts
        }).fillna(0).sort_index()

        ax = plot_df.plot(kind="bar", figsize=(6,4))
        ax.set_title(f"Top Feature: {feature}")
        ax.set_ylabel("Proportion")
        ax.set_xlabel("Permission Present (0 = No, 1 = Yes)")

        plt.tight_layout()
        # Save plot inside the folder
        plt.savefig(f"{plot_dir}/{feature}.png")
        plt.close()

    print(f"✅ Saved top {top_n} feature plots → {plot_dir}/")

    return separability.head(top_n)
