# rule_based_scorer.py
import json
import pandas as pd

def load_dangerous_permissions(json_path="dangerous_permissions.json"):
    with open(json_path, "r") as f:
        return json.load(f)

def compute_risk_score(row, dangerous_perms):
    """
    row: pandas Series (a single sample's feature vector)
    dangerous_perms: list of permission names
    Returns: integer score = number of dangerous permissions present (value == 1)
    """
    score = 0
    for perm in dangerous_perms:
        if perm in row.index and row[perm] == 1:
            score += 1
    return score

def classify(score, threshold=3):
    """Return 1 (malware) if score >= threshold, else 0 (benign)."""
    return 1 if score >= threshold else 0

def add_rule_based_predictions(df, dangerous_perms, threshold=3):
    """
    df: DataFrame with features (columns = permissions)
    Returns: Series of predictions (0/1) based on rule-based scoring
    """
    scores = df.apply(lambda row: compute_risk_score(row, dangerous_perms), axis=1)
    preds = scores.apply(lambda s: classify(s, threshold))
    return preds, scores