import streamlit as st
import pandas as pd
import numpy as np
import joblib
import hashlib
import os
import math
import matplotlib.pyplot as plt
from collections import Counter
from pathlib import Path
from file_utils import get_info,calculate_entropy
from vector_builder import generate_feature_dataframe

# Load SVM model & scaler
model = joblib.load("svm_model.joblib")
scaler = joblib.load("scaler.joblib")



st.set_page_config(page_title="Malware Detection App", layout="centered")
st.title("üõ°Ô∏è Malware Detection System(Support Vector Machine)")

# --- Tabs ---
tab1, tab2 = st.tabs(["üîç Predict from CSV", "üìÇ File Metadata Scanner"])

# ========================
# Tab 1 - CSV-based SVM
# ========================
with tab1:
    st.markdown("Upload a CSV of extracted permissions to classify applications.")

    uploaded_file = st.file_uploader("üì§ Upload CSV", type=["csv"])

    if uploaded_file is not None:
        df = pd.read_csv(uploaded_file)
        st.subheader("üìä Uploaded Data Preview")
        st.dataframe(df.head(10))

        
        X = generate_feature_dataframe(df)

        try:
            X_scaled = scaler.transform(X)
            preds = model.predict(X_scaled)
            proba = model.predict_proba(X_scaled)
            confidence_scores = [round(max(p) * 100, 2) for p in proba]
            

            df["Prediction"] = preds
            df["Prediction_Label"] = df["Prediction"].map({"Benign":0, "Malware":1})
            df["Confidence (%)"] = confidence_scores

            st.success("‚úÖ Predictions Complete")
            st.dataframe(df[["Prediction", "Prediction_Label","Confidence (%)"]].head(10))

            # Chart Summary
            st.subheader("üìà Prediction Summary")
            counts = df["Prediction_Label"].value_counts()
            fig, ax = plt.subplots()
            ax.bar(counts.index, counts.values, color=["green", "red"])
            ax.set_ylabel("Count")
            st.pyplot(fig)

            # Download
            csv = df.to_csv(index=False).encode("utf-8")
            st.download_button("‚¨áÔ∏è Download Results", csv, "malware_predictions.csv", "text/csv")
        except Exception as e:
            st.error(f"‚ùå Error processing file: {e}")

# ========================
# Tab 2 - File Metadata Scanner
# ========================
with tab2:
    st.markdown("Upload a `.exe` or `.txt` file to scan basic metadata.")

    file = st.file_uploader("üìÅ Upload File (.exe, .txt)", type=["exe", "txt"])
   
    if file is not None:
        st.subheader("üìÑ File Metadata")
        try:
            file_info = get_info(file)
            for key, value in file_info.items():
                st.write(f"**{key}**: {value}")
            if file_info["Suspicious"].startswith("‚ö†Ô∏è"):
                st.warning("This file is flagged as suspicious due to high entropy (> 7.5).")
            else:
                st.success("This file appears normal based on entropy.")
        except Exception as e:
            st.error(f"‚ùå Failed to extract metadata: {e}")
