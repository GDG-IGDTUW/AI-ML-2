import pandas as pd
import joblib
from sklearn.metrics import classification_report, confusion_matrix
from rule_based_scorer import load_dangerous_permissions, add_rule_based_predictions

# Load test data
test_df = pd.read_csv("splits/test.csv")
X_test = test_df.drop(columns=["label"])
y_test = test_df["label"]  # assuming 0/1 integers

# 1. SVM predictions
model = joblib.load("svm_model.joblib")
scaler = joblib.load("scaler.joblib")
X_scaled = scaler.transform(X_test)
svm_preds_str = model.predict(X_scaled)   # returns ["Benign", "Malware", ...]
# Convert SVM predictions to binary (0/1)
svm_preds = pd.Series(svm_preds_str).map({"Benign": 0, "Malware": 1})

# 2. Rule-based predictions
dangerous_perms = load_dangerous_permissions()
rule_preds, _ = add_rule_based_predictions(X_test, dangerous_perms, threshold=3)  # returns 0/1

# 3. Print metrics
print("=== SVM Classifier ===")
print(classification_report(y_test, svm_preds, target_names=["Benign", "Malware"]))
print(confusion_matrix(y_test, svm_preds))

print("\n=== Rule-Based Baseline ===")
print(classification_report(y_test, rule_preds, target_names=["Benign", "Malware"]))
print(confusion_matrix(y_test, rule_preds))